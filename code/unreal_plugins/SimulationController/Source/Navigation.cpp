#include "Navigation.h"

Navigation::Navigation(APawn* pawnAgent): pawnAgent_(pawnAgent)
{
    // Initialize navigation:
    indexPath_ = 0; 
    navSystemRebuild();

    initialPosition_ = pawnAgent_->GetActorLocation(); // Initial position of the agent

    navQuery_ = FPathFindingQuery(*pawnAgent_, *navData_, initialPosition_, FVector(0.0f, 0.0f, 0.0f));

    // Set the path query such that case no path to the target can be found, a path that brings the agent as close as possible to the target can still be generated
    navQuery_.SetAllowPartialPaths(true);
    
    std::string id = Config::getValue<std::string>({"INTERIORSIM", "MAP_ID"});

    if (id == "/Game/Maps/Map_237081640"){
        executionCounter_ = 0;
    }
    else if (id == "/Game/Maps/Map_237081739"){
        executionCounter_ = 110;
    }
    else if (id == "/Game/Maps/Map_239748000"){
        executionCounter_ = 220;
    }
    else if (id == "/Game/Maps/Map_239784016"){
        executionCounter_ = 330;
    }
    else if (id == "/Game/Maps/Map_239784069"){
        executionCounter_ = 440;
    }
    else {
            ASSERT(false);
    }
}

Navigation::~Navigation()
{
}

void Navigation::resetNavigation()
{
    indexPath_ = 0; 
    // navSystemRebuild();

    // initialPosition_ = pawnAgent_->GetActorLocation(); // Initial position of the agent

    // navQuery_ = FPathFindingQuery(*pawnAgent_, *navData_, initialPosition_, FVector(0.0f, 0.0f, 0.0f));

    // // Set the path query such that case no path to the target can be found, a path that brings the agent as close as possible to the target can still be generated
    // navQuery_.SetAllowPartialPaths(true);

    
}

FVector Navigation::generateRandomInitialPosition()
{
    indexPath_ = 0; 
    FVector initialPosition;

    // Spawn the agent in a random location within the navigation mesh:
    if (Config::getValue<bool>({"SIMULATION_CONTROLLER", "NAVIGATION", "SPAWN_ON_NAV_MESH"})) {

        int trial = 0;
        FNavLocation navLocation = navMesh_->GetRandomPoint();
        while (trial < 100) { 
            if (navLocation.Location.Z >= Config::getValue<float>({"SIMULATION_CONTROLLER", "NAVIGATION", "AGENT_POSITION_Z_MIN"}) and navLocation.Location.Z <= Config::getValue<float>({"SIMULATION_CONTROLLER", "NAVIGATION", "AGENT_POSITION_Z_MAX"})) {
                break;
            }
            std::cout << "navLocation.Location = [" << navLocation.Location.X << ", " << navLocation.Location.Y << ", " << navLocation.Location.Z << "]" << std::endl;
            navLocation = navMesh_->GetRandomPoint();
            trial++;
        } 
        initialPosition_ = navLocation.Location;       
    }
    else { 
        initialPosition_ = FVector(0);
    }

    // TODO: debug this mess after the paper submission... 
    // use BoxTracing to adjust pawn spawn height.
    // use mesh bounding box instead of setting.
    //std::cout << "-------------------------------------------" << std::endl;
    //FRotator spawnRotation = pawnAgent_->GetActorRotation();
    //FVector center = FVector(0.0f, 0.0f, 3.0f);
    //std::cout << "initialPosition = [" << initialPosition_.X << ", " << initialPosition_.Y << ", " << initialPosition_.Z << "]" << std::endl;
    //traceGround(initialPosition_, spawnRotation, FVector(10.0f, 10.0f, 10.0f));
    //initialPosition_ = initialPosition_ + FVector(0.0f, 0.0f, -3.0f);
    //std::cout << "initialPosition_GND = [" << initialPosition_.X << ", " << initialPosition_.Y << ", " << initialPosition_.Z << "]" << std::endl;
    return initialPosition_;
}

void Navigation::generateTrajectoryToRandomTarget()
{
    int numIter = 0;
    int numberOfWayPoints = 0;
    float pathCriterion = 0.0f;
    float bestPathCriterion = 0.0f;
    FNavLocation bestTargetLocation;
    FVector2D relativePositionToTarget(0.0f, 0.0f);

    // Path generation polling to get "interesting" paths in every experiment:
    float trajLength = 0.0;
    while (numIter < Config::getValue<int>({"SIMULATION_CONTROLLER", "NAVIGATION", "MAX_ITER_REPLAN"})) // Try to generate interesting trajectories with multiple waypoints
    {
        // Get a random target point, to be reached by the agent:
        ASSERT(navSys_->GetRandomReachablePointInRadius(initialPosition_, Config::getValue<float>({"SIMULATION_CONTROLLER", "NAVIGATION", "TARGET_RADIUS"}), targetLocation_));

        // Update relative position between the agent and its new target:
        relativePositionToTarget.X = (targetLocation_.Location - initialPosition_).X;
        relativePositionToTarget.Y = (targetLocation_.Location - initialPosition_).Y;

        // Update navigation query with the new target:
        navQuery_ = FPathFindingQuery(*pawnAgent_, *navData_, initialPosition_, targetLocation_.Location);

        // Genrate a collision-free path between the robot position and the target point:
        FPathFindingResult collisionFreePath = navSys_->FindPathSync(navQuery_, EPathFindingMode::Type::Regular);

        // If path generation is sucessful, analyze the obtained path (it should not be too simple):
        if (collisionFreePath.IsSuccessful() and collisionFreePath.Path.IsValid()) {

            if (collisionFreePath.IsPartial()) {
                std::cout << "Only a partial path could be found by the planner..." << std::endl;
            }

            numberOfWayPoints = collisionFreePath.Path->GetPathPoints().Num();
            pathCriterion = relativePositionToTarget.Size() * Config::getValue<float>({"SIMULATION_CONTROLLER", "NAVIGATION", "PATH_WEIGHT_DIST"}) + numberOfWayPoints * relativePositionToTarget.Size() * Config::getValue<float>({"SIMULATION_CONTROLLER", "NAVIGATION", "PATH_WEIGHT_NUM_WAYPOINTS"});

            if (bestPathCriterion <= pathCriterion) {
                bestPathCriterion = pathCriterion;
                bestTargetLocation = targetLocation_;
                pathPoints_.Empty();
                pathPoints_ = collisionFreePath.Path->GetPathPoints();
                std::cout << "Iteration: " << numIter << std::endl;
                std::cout << "Cost: " << bestPathCriterion << std::endl;
                std::cout << "Number of way points: " << numberOfWayPoints << std::endl;
                std::cout << "Target distance: " << relativePositionToTarget.Size() * 0.01 << "m" << std::endl;

                trajLength = 0.0;
                for (size_t i = 0; i < numberOfWayPoints-1; i++) {
                    trajLength += FVector::Dist(pathPoints_[i].Location, pathPoints_[i+1].Location);
                }           
                std::cout << "Path length " << trajLength * 0.01 << "m" << std::endl;
            }
            numIter++;
        }
    }

    ASSERT(pathPoints_.Num() > 1);

    targetLocation_ = bestTargetLocation;

    trajectoryLength_ = trajLength * 0.01;

    std::cout << "Initial position: [" << initialPosition_.X << ", " << initialPosition_.Y << ", " << initialPosition_.Z << "]." << std::endl;
    std::cout << "Reachable position: [" << bestTargetLocation.Location.X << ", " << bestTargetLocation.Location.Y << ", " << bestTargetLocation.Location.Z << "]." << std::endl;
    std::cout << "-----------------------------------------------------------" << std::endl;
    std::cout << "Way points: " << std::endl;
    for (auto wayPoint : pathPoints_) {
        std::cout << "[" << wayPoint.Location.X << ", " << wayPoint.Location.Y << ", " << wayPoint.Location.Z << "]" << std::endl;
    }
    std::cout << "-----------------------------------------------------------" << std::endl;
    indexPath_ = 1; // Path point 0 is the initial robot position. getCurrentPathPoint() should therefore return the next point.
}

void Navigation::generateTrajectoryToPredefinedTarget()
{
    int numIter = 0;
    int numberOfWayPoints = 0;
    float pathCriterion = 0.0f;
    float bestPathCriterion = 0.0f;
    FNavLocation bestTargetLocation;
    FVector2D relativePositionToTarget(0.0f, 0.0f);

    // DIRTY HACK for neurips:
    FVector pos = getPredefinedGoalPosition();

    // Path generation polling to get "interesting" paths in every experiment:
    float trajLength = 0.0;
    while (numIter < Config::getValue<int>({"SIMULATION_CONTROLLER", "NAVIGATION", "MAX_ITER_REPLAN"})) // Try to generate interesting trajectories with multiple waypoints
    {
        // Update relative position between the agent and its new target:
        relativePositionToTarget.X = (targetLocation_.Location - initialPosition_).X;
        relativePositionToTarget.Y = (targetLocation_.Location - initialPosition_).Y;

        // Update navigation query with the new target:
        navQuery_ = FPathFindingQuery(*pawnAgent_, *navData_, initialPosition_, targetLocation_.Location);

        // Genrate a collision-free path between the robot position and the target point:
        FPathFindingResult collisionFreePath = navSys_->FindPathSync(navQuery_, EPathFindingMode::Type::Regular);

        // If path generation is sucessful, analyze the obtained path (it should not be too simple):
        if (collisionFreePath.IsSuccessful() and collisionFreePath.Path.IsValid()) {

            if (collisionFreePath.IsPartial()) {
                std::cout << "Only a partial path could be found by the planner..." << std::endl;
            }

            numberOfWayPoints = collisionFreePath.Path->GetPathPoints().Num();
            pathCriterion = relativePositionToTarget.Size() * Config::getValue<float>({"SIMULATION_CONTROLLER", "NAVIGATION", "PATH_WEIGHT_DIST"}) + numberOfWayPoints * relativePositionToTarget.Size() * Config::getValue<float>({"SIMULATION_CONTROLLER", "NAVIGATION", "PATH_WEIGHT_NUM_WAYPOINTS"});

            if (bestPathCriterion <= pathCriterion) {
                bestPathCriterion = pathCriterion;
                bestTargetLocation = targetLocation_;
                pathPoints_.Empty();
                pathPoints_ = collisionFreePath.Path->GetPathPoints();
                std::cout << "Iteration: " << numIter << std::endl;
                std::cout << "Cost: " << bestPathCriterion << std::endl;
                std::cout << "Number of way points: " << numberOfWayPoints << std::endl;
                std::cout << "Target distance: " << relativePositionToTarget.Size() * 0.01 << "m" << std::endl;

                trajLength = 0.0;
                for (size_t i = 0; i < numberOfWayPoints-1; i++) {
                    trajLength += FVector::Dist(pathPoints_[i].Location, pathPoints_[i+1].Location);
                }           
                std::cout << "Path length " << trajLength * 0.01 << "m" << std::endl;
            }
        }
        numIter++;
    }

    ASSERT(pathPoints_.Num() > 1);

    targetLocation_ = bestTargetLocation;

    trajectoryLength_ = trajLength * 0.01;

    std::cout << "Initial position: [" << initialPosition_.X << ", " << initialPosition_.Y << ", " << initialPosition_.Z << "]." << std::endl;
    std::cout << "Reachable position: [" << targetLocation_.Location.X << ", " << targetLocation_.Location.Y << ", " << targetLocation_.Location.Z << "]." << std::endl;
    std::cout << "-----------------------------------------------------------" << std::endl;
    std::cout << "Way points: " << std::endl;
    for (auto wayPoint : pathPoints_) {
        std::cout << "[" << wayPoint.Location.X << ", " << wayPoint.Location.Y << ", " << wayPoint.Location.Z << "]" << std::endl;
    }
    std::cout << "-----------------------------------------------------------" << std::endl;
    indexPath_ = 1; // Path point 0 is the initial robot position. getCurrentPathPoint() should therefore return the next point.
    executionCounter_++;
}

FVector2D Navigation::getPathPoint(size_t index)
{
    ASSERT(pathPoints_.Num() != 0);
    ASSERT(index < pathPoints_.Num());
    return FVector2D(pathPoints_[index].Location.X, pathPoints_[index].Location.Y);
}

FVector2D Navigation::getCurrentPathPoint()
{
    ASSERT(pathPoints_.Num() != 0);
    ASSERT(indexPath_ < pathPoints_.Num());
    return FVector2D(pathPoints_[indexPath_].Location.X, pathPoints_[indexPath_].Location.Y);
}

FVector2D Navigation::updateNavigation()
{
    const FVector agent_current_location = pawnAgent_->GetActorLocation();
    FVector2D relative_position_to_goal = getCurrentPathPoint() - FVector2D(agent_current_location.X, agent_current_location.Y);

    targetReached_ = false;

    // If a waypoint is reached
    if ((relative_position_to_goal.Size() * 0.01) < Config::getValue<float>({"SIMULATION_CONTROLLER", "NAVIGATION", "ACCEPTANCE_RADIUS"})) { 

        if (indexPath_ < pathPoints_.Num() - 1) { // Move to the next waypoint
            std::cout << "######## Reached waypoint " << indexPath_ << " over " << pathPoints_.Num() - 1 << " ########" << std::endl;
            indexPath_++;
        }
        else { // We reached the final target
            std::cout << "############ Reached the target location ! ############" << std::endl;
            targetReached_ = true;
        }
    }

    return getCurrentPathPoint();
}

FVector Navigation::getPredefinedInitialPosition()
{
std::cout << "#################################################################################################" << std::endl;
    // Dirty hack ...
    std::vector<float> init_x = {-55.17058, 605.828, -49.09923, -72.088936, 78.05097, 213.83377, -143.6522, 13.976796, -552.5078, 184.92464, -0.02431202, 416.15237, 127.012, 161.02725, 90.90162, -28.501534, 648.50714, -403.23865, -49.50487, -166.94272, -38.213806, -59.03158, -349.25177, -104.83549, -422.43, 57.131504, 440.66553, 219.89088, 45.462708, 96.62158, -36.103622, 177.29239, 467.16986, -82.20623, -113.81563, -69.635895, 165.37589, -100.849945, 114.814514, -77.314545, -333.49872, 347.20706, 170.99013, 160.66351, 69.871994, 202.71648, 190.22708, 576.37585, 543.15356, -425.8011, -430.73856, 362.06506, 128.23683, -21.844406, -604.4077, 121.1786, 578.78595, -75.71443, -10.190317, -402.17734, -0.31946927, -40.28758, 157.7239, 46.827477, -32.207527, 42.503677, 128.42712, 354.00894, 143.39793, -90.58948, -46.645462, 70.33225, 652.43286, -236.31467, 224.66829, -55.900497, 303.84818, -79.15496, 103.326675, -76.896034, -33.7125, -71.50012, -69.88772, 388.90073, -129.0779, 388.67725, -77.83576, 31.113535, 90.05395, 44.506943, -101.53199, 615.53296, 81.99395, -68.69702, 166.2673, -33.728325, -28.17116, -111.26334, -365.5891, -27.327139, 5.769758, 102.68682, -405.52936, -35.785988, -206.56557, 412.36142, -321.8762, 307.4693, 393.26636, -71.357635, 332.62787, 7.7638845, -26.513977, -81.65138, -285.6944, 19.950651, 366.1587, 194.24077, 604.469, -13.574216, -66.428635, -526.32794, -49.780174, -66.54176, -56.596924, -23.893738, -74.819176, -304.88577, 154.76704, -96.18092, 102.40947, 30.944006, -48.84521, -73.591644, -433.67197, 499.97366, -11.31549, 71.63752, -169.12613, 16.703848, 396.75522, -146.00296, 381.0787, 33.934326, -2.2070034, 159.63094, -27.4091, -308.34924, 338.49863, -17.83227, 532.09656, -481.83997, -56.706356, 96.34919, 517.1622, 23.097742, -538.5167, -80.93999, 158.86624, 231.42294, -10.116046, 103.850494, -543.0999, -0.55289114, -7.8031125, -59.894962, -531.27704, -547.6116, 183.3127, -87.5982, -50.157112, -595.28894, 304.72687, -34.463634, 119.35924, 226.01788, 649.371, 155.56143, -41.548466, -64.04184, -88.99487, -43.275475, 148.55121, -29.645384, 308.3476, 86.43219, -49.082798, 212.08199, 11.435111, 53.066097, 594.5963, 99.582306, -83.57587, -29.759068, 11.1832075, 84.98454, -390.34796, -501.17816, -465.3144, 207.49054, 390.23825, -26.740816, -67.2814, -359.26123, -73.849014, -84.75661, 643.8976, 205.56593, 1.4508483, 305.1172, 170.87126, -468.87244, 320.7199, 0.8339457, 376.06433, 211.05186, -28.99752, -23.612, 366.5639, -74.02793, 329.6231, 216.75885, 110.301575, -266.38766, 1.8159759, -56.783386, -49.170906, -630.1787, -552.2273, -47.490845, 135.51389, -43.060406, -226.15755, -78.13698, -7.866948, 235.45918, -47.298615, -296.38812, 35.4241, 379.8015, 380.0498, 33.331516, 39.734924, -64.007034, 48.851368, 370.08014, 13.046911, -545.6002, -20.748953, -29.367548, 20.126757, 66.81911, 199.1266, -8.734639, -174.35406, -36.37287, -99.59086, -18.856281, -50.985905, -46.548916, 134.09276, 54.682484, 104.80801, 453.24063, -13.063965, 380.13806, 66.48285, 364.35864, 71.25084, -274.3961, 387.211, -68.344635, -204.38821, 483.07166, 389.70804, -498.74405, 146.12065, -36.291565, 321.39456, 16.5699, -47.16773, 380.07007, -137.94778, -25.728077, -2.774454, -589.0807, 616.5432, -67.401794, 341.45395, 416.5396, 237.87733, -507.09845, 11.632912, 328.60596, 585.71674, -73.83685, 327.03638, -60.589127, -81.61047, 148.14339, -7.842391, 181.71016, -61.53792, 56.713142, -562.29346, 133.49258, 628.8475, 106.57787, -53.195652, 327.6194, 370.803, -7.8683424, 88.657684, 420.64655, -63.878433, 330.94824, -592.5637, 33.190517, 197.56767, -6.606819, -569.5035, -307.36148, -27.006212, -0.6438435, -89.37919, -33.685276, 499.69073, 349.18402, 128.71603, 144.43213, 208.43219, -51.87151, -10.724803, -30.261326, 47.32248, -57.859085, 243.74748, -61.045914, 112.86629, -31.08757, 650.62366, -49.199482, 504.1847, 84.69388, 226.92548, -33.54843, 112.60782, 149.14139, -41.595654, -81.919235, 203.83481, -44.352596, -473.429, 206.134, 345.62958, 125.15943, -23.818356, 136.20172, 165.55997, -59.299538, -473.00876, -46.445965, 182.328, 132.63014, -187.89915, 425.44702, 145.91586, 45.54649, -21.50861, -60.65621, 356.5434, 133.34468, -49.612667, -45.52705, -34.865993, -12.975624, 64.858795, -473.1547, 55.70226, 98.150444, 223.80362, -65.93886, 98.766365, 199.68857, -42.485275, -116.44257, 603.51404, -32.99669, 237.51079, 315.12927, -477.2125, -12.384741, 108.82336, -0.4096201, -42.643604, 167.038, -162.99815, 380.9082, -160.89203, -62.11793, 362.1543, 191.49498, -141.67474, 347.2635, -553.24695, -67.315865, 144.64662, -37.157043, -11.511605, 152.6955, 415.411, -56.452454, 74.59017, -37.192223, -477.5824, -0.4928339, -251.79823, 156.0085, 312.41992, -69.580475, 306.1608, 337.4953, -603.54614, 126.20686, 303.34598, 438.13715, -436.94357, -105.97681, -544.3777, -63.46802, -15.34637, 65.57775, -71.694786, -441.37772, 367.5356, -50.467915, -36.329967, 78.2232, 114.0136, 108.68427, -63.059288, 148.93079, 170.80933, 210.17982, -29.20638, 134.73969, -49.74096, 91.45028, -42.560963, 404.13828, -161.04877, 102.39782, -500.1699, -31.425089, -379.8746, 397.37683, -418.397, 458.6349, 219.11017, -246.2221, 354.3942, 86.78868, 155.64307, -504.75293, -42.419624, -41.348297, -578.6843, -555.85626, 171.30643, 232.81519, -22.057423, -34.544823, -12.965678, 199.67038, 306.0189, 346.16644, -14.314483, -82.03081, 16.51846, 91.31906, 659.38135, -55.81348, 372.89536, 487.8913, 429.19592, 183.85359, 406.3238, 119.75626, 16.081682, 624.0851, -355.658, 104.41959, 590.0442, 107.687294, -5.920024, 79.606316, -54.140247, 177.86806, -33.736565, 134.45177, -494.2266, -460.5352, -17.224073, 347.82196, -38.58233, -9.331885, -39.041733, -10.990019, 349.12686, 51.50922, -39.114956, 1.7257156, 114.68151, 119.75334, 66.21794, -48.46122, 28.104256, -124.893295, 650.66016, -550.2549, -1.4731605, -72.79477, 59.740776, 118.239685, 65.453674, -637.10126, -49.1541, 68.19688, 104.454575, 159.66447, 358.52533, 627.4197, -77.669716, -49.700966, 227.15425, 16.016413, -135.39717, 362.40445, 147.04927, -474.1296, 144.72235, 375.60016, -81.59433, -646.80975, -132.77435, 342.68085, 322.13635, 372.93164, -540.903, 215.98595};
    std::vector<float> init_y = {518.1801, 109.942924, 548.73047, 289.6065, -223.70103, 296.7471, -176.19467, -589.7674, -227.84125, 422.3438, -329.35782, 393.69232, 458.10077, -153.38052, 559.77405, -193.20787, 109.865555, -243.2776, 447.55386, -187.44366, -273.21307, 324.39148, -199.05795, -193.59868, -172.9619, -273.21695, 236.63391, 336.99396, 463.84406, -593.21875, 10.227643, -179.4764, 379.43976, 579.2591, -515.3859, 492.9549, 194.49313, 275.7478, 12.434166, 469.74286, -123.14276, -43.35393, 345.09436, -67.14553, -46.51708, -114.69254, -155.68114, 79.570305, -3880.935, -294.13474, -319.818, 240.54674, -129.07097, -445.83682, -296.2234, 309.35095, 106.32361, 8.220734, -351.7049, -195.8364, 512.74866, 470.96558, 186.39877, -582.4285, 1.6925528, -161.38931, 309.1462, 201.00233, 377.75317, -192.06831, 512.1212, -298.53192, 393.2811, -228.86325, -174.44798, -160.99924, 283.13663, 499.09918, -272.78476, 245.37845, -277.1383, 332.22125, -160.73048, 30.04981, -109.11627, 81.411156, 526.1918, -189.71205, -162.65764, 578.1594, -616.832, 428.49945, 39.78347, -518.50543, -45.166546, 242.49945, -281.79184, -531.5057, -143.04826, 419.32474, 284.46582, -0.02060332, -275.08652, -349.92877, -142.26929, 428.58188, -173.21341, -118.60378, -158.81026, 577.6223, -20.911932, -164.02078, -289.5638, 329.25146, -175.3248, -303.46988, 397.0074, -57.36756, 382.26154, 444.83057, 317.66638, -265.21173, 335.75687, 261.84744, 427.3907, 518.6292, 279.1707, -168.6246, 321.7237, 313.41254, -588.80066, 337.9251, 538.599, 274.90936, -293.02747, 417.92783, 350.14606, 18.541815, -140.74182, -174.7485, 241.74922, -166.29112, 228.14784, 469.0976, 338.90918, 21.666779, 511.63293, -192.48509, -1.8307462, -463.00848, 77.49256, -259.89688, -198.28642, -581.62396, 432.55682, 358.4855, -242.3029, 286.29306, -191.17317, -78.034515, 490.36475, -378.53336, -244.40503, 476.204, 455.8697, 353.82562, -203.55542, -284.04642, 304.80737, 314.88916, -447.78888, -311.22214, -44.757217, 541.73145, -458.28836, -119.63195, 402.65045, 177.81573, 409.9955, 435.06192, 325.4598, 443.98264, 86.12128, -319.45752, 416.89233, -599.42896, 461.87146, -146.92403, 344.81573, -602.4749, 88.28511, -165.63307, -191.12025, 490.8246, -271.77164, 62.280304, -188.00821, -221.03462, -287.37634, -138.95268, -209.87872, 467.67303, 554.5082, -186.75174, 577.3375, 331.25494, 405.94968, -209.96883, -341.63745, -55.05899, -44.856976, -363.44882, -11.134634, -519.9593, -58.359207, 325.76758, 574.1402, 251.85252, -151.57552, -615.11414, 29.520967, -141.96921, -381.05457, -148.36398, -345.15564, 246.30968, 275.30103, -165.5171, -234.71713, 336.81253, 535.6616, -205.57648, -162.44289, 494.28067, 347.75443, 436.9468, 425.7064, -188.10017, -579.9722, -68.82115, -16.043024, 441.6573, -146.52087, -145.26282, 476.35425, -139.97784, -280.1916, -285.3779, 480.44647, -197.00813, 508.76462, -211.00128, -166.43419, 301.56952, -194.15492, -324.38678, -144.17776, 520.6981, 352.07397, -0.9478404, 143.21297, 570.97986, -568.4334, 430.42563, 287.00858, 219.98207, -177.50003, -78.09846, -563.13666, -134.38638, 214.17168, 543.95386, -207.5187, 415.03583, -134.36595, -223.72092, 53.30528, -174.1018, 150.87605, -327.6196, 423.7829, 142.47635, -198.39749, 363.65408, 355.49268, -194.82953, 376.36633, 289.888, 196.5723, 192.05864, 331.938, -233.12036, 469.87787, 394.71255, 389.4486, -460.0839, -39.60269, 346.5851, 259.96893, 233.03397, 324.654, -148.69595, -551.9584, 497.44363, -271.1994, -143.92447, 408.00977, -205.25378, 535.5403, 151.27934, 152.44041, 543.22595, -203.47032, 396.00427, 558.2928, -62.729034, -303.6936, -205.93582, -133.5499, 518.06744, -274.89923, -187.3101, -495.09882, 533.0257, -631.4285, 577.1141, 406.8994, 38.31375, -17.04024, -35.766518, -230.1948, 492.35938, 521.50433, 469.3696, -202.21893, 439.31247, -141.97705, 489.84332, -153.4754, 303.0165, 385.91318, -408.46347, 448.20963, -369.4488, 470.18143, 357.74545, -149.87755, 202.30765, -624.184, -172.96663, 449.906, 430.4255, -242.93665, -202.40956, 38.550964, -426.60498, -488.3769, -94.38158, 306.63654, 530.0623, -200.34218, -180.71658, 53.24318, -158.33229, -123.14409, 182.61053, 431.59482, -177.45355, -190.1075, 577.7738, -168.87881, -67.1628, -187.22925, -157.9385, 419.7293, -328.46347, -157.01674, -229.73122, -175.98097, 503.75104, -41.57086, 471.42847, 426.10657, -207.5805, 441.2887, -206.68294, 428.47284, 502.83127, -177.26514, -97.508446, -242.80876, 475.49905, 123.08418, 6.8959994, 250.05113, -156.61935, -152.03505, -100.5962, -125.843124, 482.54092, -10.553119, -80.0738, -203.23734, -22.012209, -249.26306, 354.34335, 533.6178, 549.4208, 441.30887, 572.6271, 99.61218, 282.07193, -579.0816, 285.47958, -241.345, 458.52097, -158.89001, 150.82893, -200.96373, 262.3053, 6.1072416, -210.39989, -220.12515, 123.977325, 3.0757265, 92.14144, -178.57599, -163.18723, -189.3385, 247.86859, 375.82083, 440.8351, 440.03677, -255.38359, 200.77534, 329.35892, 257.6, 366.91986, -216.52682, -447.3862, 442.80505, 87.435745, -192.68488, -228.71121, 338.11984, -141.80461, 296.63528, 9.774717, -353.8834, 381.70572, -191.37778, -590.9605, -276.96442, 341.4093, -179.45963, 381.83005, -207.0019, 385.7472, -164.18317, -201.62025, -111.31622, -330.20682, -50.694405, -298.1201, 465.25494, -132.94398, -236.85898, -208.51009, 159.17584, -162.59021, 360.4074, 280.76843, 517.9685, -40.03901, -151.7643, -83.16211, 326.67993, 481.79092, -596.9716, -175.84251, 436.58105, 316.57797, 122.489944, 73.41216, 437.27567, 471.03168, 196.47484, -325.59842, -200.42662, 74.63659, -180.61269, -548.8965, 392.6231, -316.20282, 338.9105, -325.06863, -381.41086, 280.82712, 544.6703, 550.2755, -321.27402, -283.94113, -322.37756, -26.829165, -488.81946, 461.0813, 11.341668, 349.44806, 194.04178, -198.2234, -512.07983, -194.04202, -451.1796, 366.7057, -581.7046, 567.72833, 490.47607, -125.93827, 386.0863, -199.68802, 306.45636, 257.06088, -210.77751, 212.6442, 552.26025, -157.81284, 250.13478, 446.4607, 290.77377, -56.780773, 401.47705, 406.10284, -208.56651, 324.35803, 431.41104, -169.05269, -31.18015, 403.53418, -64.186714, -224.26973, -143.15948, -142.44084, 467.35126, -176.71114, -89.44123, 108.70091, 167.03983, 163.06665, -214.76122, -173.187};
    std::vector<float> init_z = {5.372072, 5.3720665, 5.3720665, 5.3727283, 32.71784, 5.3720665, 5.373518, 15.498206, 5.3720665, 5.3728237, 6.0980864, 5.372217, 5.3720665, 5.372573, 5.3729725, 5.3720655, 5.3720503, 5.372572, 5.3725166, 5.3721685, 5.3728848, 5.372052, 5.3726473, 5.372877, 5.3935356, 5.372463, 31.095612, 5.3720665, 5.3720665, 9.638956, 5.3720665, 5.3720665, 9.636888, 5.3732853, 6.2062564, 5.3720665, 5.3830805, 5.3720665, 5.3720665, 5.3720684, 5.3720665, 5.3721066, 5.3720913, 5.3723783, 5.3720665, 5.3720665, 5.372078, 5.3728733, -25661.11, 5.3725433, 5.372204, 7.19577, 5.3729324, 6.098073, 5.3720665, 5.3720665, 5.372095, 6.4417048, 10.713971, 5.3730774, 5.3720665, 5.372217, 5.372674, 10.279131, 5.372096, 5.3720665, 5.3726425, 7.1298323, 5.3736596, 5.3724747, 5.3720665, 5.3720493, 5.3730583, 5.8793507, 5.3800344, 5.372123, 14.43379, 5.3721, 5.3724833, 5.3720665, 5.372057, 5.3725967, 5.372883, 5.3720665, 5.3728848, 5.3720603, 5.3720665, 5.3720665, 5.3724003, 5.3721027, 2.2187262, 5.372841, 5.3720665, 6.458581, 5.372802, 5.372883, 5.372695, 11.497971, 5.3720665, 5.3818264, 5.3846006, 5.3723984, 5.5299416, 10.816162, 5.372878, 5.3723783, 5.42132, 5.373003, 5.372549, 5.372842, 5.37237, 5.372057, 5.3728867, 5.372957, 5.3723097, 7.283767, 5.3730335, 5.3727894, 5.3720665, 5.3724823, 5.3720665, 5.3720665, 5.3720665, 5.37265, 5.37269, 5.372822, 5.3720665, 5.3721333, 5.3720665, 5.3722925, 14.035299, 5.3720665, 5.3720875, 5.3720665, 5.372074, 5.3720665, 5.3720493, 5.372719, 5.3727074, 5.3720665, 6.967663, 5.372879, 10.631177, 5.3720894, 5.372077, 5.37232, 5.3724957, 5.3723927, 5.3720665, 6.679183, 5.3720665, 5.3720665, 5.3721037, 12.171927, 5.372877, 5.3720636, 5.3720603, 5.3720703, 5.372079, 6.115175, 5.3720665, 7.922208, 5.3728724, 5.3720665, 5.372879, 5.3720865, 5.3720503, 5.3723745, 5.3720493, 5.372591, 16.349373, 5.372882, 5.3720856, 5.372075, 32.71592, 5.3724947, 5.372078, 5.372883, 25.92253, 5.3728676, 5.3720665, 5.3720665, 5.3720665, 9.4627905, 5.3720493, 0.09065509, 5.3720655, 5.3720665, 5.3720665, 10.990021, 5.3720665, 5.3727646, 5.3721905, 5.372074, 5.3726454, 5.372861, 5.3720665, 5.3720665, 5.3720665, 5.3720694, 5.3720713, 5.3727856, 5.3720613, 5.3720646, 5.372818, 5.372877, 5.372758, 5.37212, 6.0978336, 5.372755, 5.372057, 5.3720665, 5.372877, 8.21122, 5.372838, 5.372761, 5.3720665, 5.3720665, 5.372921, 2.7975578, 5.3720665, 5.372057, 3.6588159, 5.3720665, 0.7118945, 5.3720665, 5.3720665, 5.383436, 5.3720665, 5.3720818, 5.3727922, 5.372061, 5.372076, 5.372078, 5.3720665, 5.372057, 5.3728704, 5.3720665, 6.4203258, 5.3720665, 5.3722296, 5.3728714, 5.3720665, 5.3720636, 5.372074, 5.3720665, 5.3727846, 5.3720503, 5.3720665, 5.3727245, 5.3720665, 5.372183, 5.3728514, 5.3720665, 5.3720703, 15.044289, 5.372074, 5.3720665, 5.3720665, 5.3720665, 5.3720655, 5.3730564, 10.324353, 5.372057, 5.3720665, 12.024912, 5.372057, 5.3720665, 15.171497, 5.3720665, 9.707058, 5.3725796, 5.3720665, 5.372678, 5.3728857, 5.3720684, 5.372761, 5.37278, 8.165314, 15.709482, 5.3720703, 6.7798405, 5.3726997, 5.3723583, 5.3720665, 5.372076, 5.372902, 5.3728275, 4.656451, 12.363775, 5.3725014, 5.372057, 5.372078, 5.3720665, 5.372736, 6.0978994, 5.372344, 5.3720646, 5.3720665, 5.372157, 5.3727894, 5.3720603, 3.2074335, 5.372057, 5.3720665, 5.3720603, 5.3720665, 5.3720503, 5.3720665, 0.29370832, 6.876713, 5.3720665, 5.3720665, 5.3720655, 5.4638824, 5.3720665, 5.3720646, 5.3720665, 5.3720665, 5.3724384, 5.3720665, 5.372858, 11.0322895, 5.3720665, 5.372057, 5.372881, 5.3728724, 5.372801, 5.3720665, 5.3727837, 8.969873, 5.3720665, 5.3720665, 5.3720665, 5.3720665, 5.4328938, 5.3724747, 5.3720665, 5.372629, 5.3720665, 5.3720665, -0.072808266, 5.3720694, 3.2268584, 5.3721886, 5.37206, 5.372074, 5.3728657, 6.2478585, 5.3720665, 5.3729267, 5.372752, 5.3720646, 5.372057, 5.372074, 5.3720665, 11.257588, 5.3720665, 5.372057, 5.3720665, 5.372468, 5.372633, 5.3720665, 5.3720665, 5.372057, 7.034962, 5.372409, 5.5613103, 5.3720493, 5.3720665, 5.3721275, 5.3720665, 5.3724976, 5.374072, 6.240091, 11.154648, 5.372078, 5.3724346, 5.3720665, 5.3720665, 5.3724527, 5.3720636, 5.3728065, 5.372488, 5.3720684, 5.3720665, 5.3720503, 5.3723297, 5.372882, 5.3720665, 5.3720493, 5.372509, 5.372856, 5.372876, 5.372938, 5.372181, 5.3720665, 5.37232, 5.3724833, 5.50631, 5.3728714, 5.372347, 5.372864, 5.3720665, 5.372734, 5.3720913, 5.372261, 5.3726025, 5.3720665, 5.3720503, 0.799469, 6.058429, 15.373046, 5.3758187, 5.3720503, 5.3728676, 5.3720665, 5.3720665, 5.372305, 5.372057, 5.3729515, 5.372608, 5.3720665, 5.372772, 5.3727036, 12.019558, 5.3720665, 5.3727646, 5.3720665, 5.3720665, 5.3726273, 5.3720665, 5.3720684, 5.3741055, 7.800451, 5.3724957, 5.372487, 5.4135923, 5.3720665, 3.6685162, 5.386305, 5.3720665, 5.372326, 5.8911543, 5.3720703, 5.385184, 5.372528, 5.3726454, -0.041918755, 22.125076, 5.372057, 3.864413, 5.3720818, 5.3725405, 5.372921, 1.9342928, 5.3728065, 9.697311, 5.3720665, 5.3720665, 5.3720665, 10.22323, 5.3728495, 5.372778, 5.3720665, 5.3720493, 5.3727856, 5.3720665, 5.372057, 5.372672, 5.3720665, 5.3720665, 5.372489, 5.3727818, 5.3720665, 5.3726587, 5.3720503, 5.372654, 3.639492, 5.3720503, 5.372057, 5.3726273, 14.128801, 5.372074, 5.3724957, 5.3720503, 7.0829663, 5.9521575, 5.3720837, 5.3720665, 5.3720665, 29.104902, 5.3720665, 9.520155, 5.3731337, 14.197947, -1.004189, 5.3720503, 5.3721523, 5.3720665, 5.527771, 5.372718, 0.5626633, 5.372079, 1.1633029, 5.3720665, 5.3720675, 5.3720503, 1.8793182, 5.3720503, -0.6373787, 5.3729286, 9.898281, 5.3720875, -3.933319, 5.372073, 5.576021, 5.3721905, 5.372055, 5.3720665, 5.3720665, 5.3720665, 5.372057, 5.37288, 5.37206, 5.3721714, 5.3728495, 5.372635, 5.372443, 5.372753, 5.372079, 5.372484, 5.3720655, 5.372856, 5.372795, 5.3728056, 5.377885, 5.3720665, 5.3727417, 5.3720665, 5.3720665, 5.3729305, 5.3720603, 5.3720665, 5.3720665, -0.10440159, 15.719942, 11.118353, 5.3720646, 5.403884};
    std::cout << "executionCounter_ : " << executionCounter_ << std::endl;
std::cout << "#################################################################################################" << std::endl;
    initialPosition_ = FVector(init_x.at(executionCounter_), init_y.at(executionCounter_), init_z.at(executionCounter_) < 5.37f ? 5.38f : init_z.at(executionCounter_));

    return initialPosition_;
}

FVector Navigation::getPredefinedGoalPosition()
{
    // Dirty hack ...
    std::vector<float> goal_x = {157.707, 422.3461, 25.281965, 63.621063, 166.7038, 158.72296, 172.13914, 3.5349429, -627.5409, 164.53569, -44.64239, 508.2923, -29.323458, -550.6401, 30.598104, -70.265015, 556.2668, -511.09097, 164.31155, 54.295006, -39.521145, 138.6601, 103.65701, 47.704037, -620.82263, -99.76218, 344.09497, 254.0091, 123.05524, 49.49785, -218.63974, 176.48691, 357.2368, 18.109606, -37.400383, 133.35387, 21.53685, -407.1042, -32.721165, -74.34788, 15.726837, 615.9711, 134.34651, -553.8288, 84.55586, 130.44722, -62.239574, 534.12195, 418.86728, -582.5182, -496.78595, 346.81525, 185.0401, 74.34524, 115.12254, 45.849625, 372.35538, 74.96592, 77.741, 224.32065, 93.30401, 129.90593, 178.39017, -33.263233, 212.83823, 88.05075, 186.58162, 346.11853, 114.60882, 159.59172, 51.34323, -10.135539, 494.26663, -170.72867, 233.10588, -592.13257, 322.34827, 238.79347, 8.132667, 20.029795, -69.37199, 4.3162017, 166.94992, 398.06732, -594.4677, 305.5453, -5.8244286, -139.75674, 7.5890303, 3.6112297, -101.9528, 350.49973, 22.984522, 34.799763, 60.59014, -52.11557, -86.58078, -77.04921, -420.6376, 23.59903, 166.78008, 119.660614, -516.6589, 72.65854, 62.24891, 451.02762, -59.25768, 377.50568, 421.06274, 35.855137, 330.13495, 149.16463, -27.397984, -96.83397, -622.37555, -7.5407267, 314.84042, 164.59302, 373.9321, 26.453747, -181.85815, 101.51834, 59.132847, 5.6408973, -0.48667273, 19.864666, 22.156736, -48.737038, -649.2855, -30.986269, 43.34425, -318.6377, -64.132195, -63.791035, 226.54607, 303.69348, 210.50055, 262.58524, 85.273026, 111.25717, 383.9652, 191.77397, 406.48465, -21.827484, 226.50943, 190.54762, 69.636505, 72.65977, 356.55737, -70.541115, 308.87802, -619.6947, -215.26236, -60.31297, 380.56085, 140.17749, -201.61478, 110.73778, 60.276085, 120.6438, 185.22522, 68.843185, 211.72609, -39.1529, -10.519984, 185.95183, 239.3079, -594.4576, 232.13354, 137.99127, -28.120304, -528.2142, 622.69104, 65.70015, -420.668, -50.848164, 308.35648, 97.84331, -51.6377, 32.656837, 86.80582, -59.48654, 176.96477, -32.752266, 631.7219, 40.828655, -72.04836, -207.28998, 109.71492, 175.82524, 419.7357, 226.43594, 228.97755, 84.76065, 97.507965, -63.576145, 38.274475, 104.23372, -484.59586, 165.53046, 386.78424, -45.252136, -43.31202, 212.66669, 147.07196, 166.93921, 479.25424, -288.92493, 95.286194, 416.32202, 84.285545, -532.61505, 330.66956, 26.3772, 355.66736, 181.57675, -3.8301165, -83.22685, 336.28162, 120.620125, 310.50497, 187.82622, 219.333, 69.783104, 102.61734, 128.69104, 94.72142, -210.94745, 7.542214, 42.703484, 136.62662, -334.98877, -277.07697, 202.50955, 194.45178, 91.762886, -10.40832, -61.58084, -46.561035, 332.43466, 335.72003, 7.030134, -427.399, -253.78716, -75.322784, 317.74097, 103.224236, -39.5421, 65.62176, -427.08774, 172.09639, 139.31723, -364.04214, 145.48393, -551.557, 122.87939, 118.85826, 3.6217117, -474.08484, 90.12181, -591.2762, -67.32789, 130.30515, 322.67505, -272.6164, 386.49377, 55.95419, 427.85025, 129.87892, -270.9997, 583.50134, -44.888584, -0.020034911, 453.5779, 370.49164, 182.82385, 86.2838, -42.41909, 349.94556, 96.51033, 171.60901, 362.55322, -475.84448, 125.98268, 182.193, -20.616777, 615.36523, 249.9183, 317.7644, 322.9273, 178.36403, -272.31793, 112.190285, 354.74863, 610.81287, -259.1912, 493.89386, 121.657745, 22.86837, 86.56967, 234.87384, -56.15409, 91.12288, 0.33041596, -48.857872, 164.09938, 364.14444, 151.92256, 161.84177, 586.2482, 403.8207, -20.969315, 133.38455, 388.96948, 65.2579, 328.78204, -32.174934, 115.2259, -43.70887, 228.8258, 229.11426, -56.700623, 34.641464, 133.12999, -14.586372, 190.2307, 370.13348, 320.85684, 211.19899, 155.08641, -653.56604, 106.853325, 24.62932, -23.931423, -353.47778, 21.013348, 112.89074, -39.799942, 147.90578, -233.5934, 447.9212, 106.72604, 381.388, 73.60552, -31.397297, -30.463549, 109.82133, 233.0256, -96.64135, -166.3463, -57.209663, -76.84709, 225.46033, -351.7478, 594.2192, 4.332248, 77.77454, 135.72176, 118.77229, 58.1481, -526.4966, 204.12515, -4.7343254, 230.08807, -569.73175, 325.7207, 163.79224, -607.2589, -494.68195, 71.60318, 325.6995, 27.302467, 202.44124, -141.48288, 208.95476, -33.46559, -457.4607, 119.907265, 154.40535, 183.70178, 162.40233, -68.58885, 154.32011, 159.93001, -34.815723, 195.49776, 399.67102, 155.90732, 120.74024, 341.84625, 156.84909, -48.927864, 88.608, -542.01874, 28.853127, 99.05816, 120.45326, 541.3333, -524.9528, 58.938744, 398.46143, -472.02478, -358.80862, 331.78595, 139.14113, -66.536934, 76.69519, 42.06695, -65.02037, 206.83759, 408.76312, 158.11345, 98.384415, -293.4057, 164.34082, -71.80895, 201.99496, 190.06561, 313.68228, 181.29121, 540.47644, 400.84387, -44.565083, -476.0181, 304.0642, 384.29663, -209.9375, -304.38425, 87.55, -16.705063, -156.50409, -15.740604, 32.906746, 218.48206, 377.23718, 100.39727, -45.18952, -13.248393, -53.51919, 64.59949, 17.692856, 137.44939, 121.13669, 22.284061, -89.28781, -57.686974, -196.71109, 137.64256, 74.19797, 423.50342, -603.23596, -30.16965, -217.94684, 143.364, 220.7331, 302.3077, -327.08603, 412.02374, 103.52823, -597.7164, 506.74963, -18.39285, -276.47287, 189.62912, 93.945885, 121.95481, -38.400124, -247.15543, -498.73254, 120.34449, 47.97619, -329.09647, -69.07906, -270.0794, 308.73138, 422.01862, 129.94136, -61.527, 83.39937, 110.71396, 323.73465, -77.29692, 388.46533, 525.94196, 378.221, 82.9926, 416.0025, -36.30726, -334.784, 348.34048, -75.96022, 98.78359, 303.86005, -41.250816, -48.853924, 62.9634, -45.59901, -68.319916, 35.597847, 136.06207, -519.59766, -245.60526, -50.040226, 613.7775, 20.575027, 57.041626, 146.67886, 174.62779, 396.81525, 175.86319, 27.249844, -226.54065, 111.96133, -446.01257, 90.32057, -18.628752, -22.067764, -341.3962, 320.30817, 70.1752, -104.83066, 205.09381, -220.48685, 226.4099, -14.289564, -1.2757956, 240.68517, -26.33854, 17.574688, 138.52083, 326.40277, 325.50366, -407.1554, 163.15607, -22.351665, -71.07019, 90.38871, 468.7221, -590.83215, -17.432878, -370.73538, 381.69058, 74.06006, 80.1124, -224.14218, 385.52133, 406.54547, 596.603, 25.150602, 220.17557};
    std::vector<float> goal_y = {434.3903, 142.90297, 490.82837, -179.55312, 5.8898234, 173.62798, -80.803535, -367.85547, -146.03964, 547.92865, -310.32516, 425.52332, 537.844, -176.71284, 535.6041, 326.79694, 89.31431, -200.3764, 533.8178, -144.35612, -290.2734, 374.41315, 60.331863, -200.79147, -133.38058, -305.85788, 13.671728, -146.50499, 433.40363, -288.4981, -185.91754, -0.552319, -185.67053, 432.64673, -464.49786, 476.62775, 322.68405, -311.36182, 352.5184, 433.2223, 282.21454, 91.0112, 198.50267, -267.1551, 316.1697, 152.54892, -206.8362, 419.07556, 368.39838, -200.92702, -259.4988, 78.315346, -62.995796, -322.13092, -162.77292, -126.284805, -178.22098, 26.267485, -351.67706, 322.17676, 448.89923, 497.409, 113.374664, -300.80048, 307.33154, 329.91898, 159.88524, 70.18365, 298.50717, -29.53086, 454.36884, -327.70715, 451.87115, -196.78535, -91.72423, -240.91638, 64.66289, 477.2116, -327.54294, 323.9445, -551.6886, 247.63275, 101.87436, 387.02765, -220.40573, 50.074673, 457.55377, -195.54549, -58.23684, 464.39804, -527.5541, 17.077734, 299.38458, -450.50647, -155.44687, -200.89804, -295.26434, -399.29337, -169.60004, 535.99475, 146.5722, -15.160207, -186.90652, -377.36905, -138.59076, 368.14496, 320.47687, 411.8869, 121.94938, 548.59644, 434.875, -90.908394, -413.9052, 278.87378, -177.66078, -140.6912, 327.7856, 78.347305, 83.22768, 504.46442, -133.99542, -123.49971, 322.3897, 249.58311, 456.33575, 550.968, 370.34412, -170.11021, -141.80383, 246.45834, -353.39178, -191.53549, 486.2068, 330.13403, -70.64432, 86.663086, 6.313561, -149.7356, -167.23701, -125.35193, -118.78887, 345.84833, 171.8358, 432.12653, -153.24876, -203.22658, 474.69458, -198.38596, 123.89566, -638.1709, 65.38087, -200.9635, -163.32161, -624.7849, 16.10878, 355.36285, -155.67987, -411.19226, 322.55365, 0.43012977, 420.78732, -214.87318, 288.12408, 454.28555, 568.1097, 36.650047, 291.46475, -237.76477, -82.99646, 280.27933, -641.9025, -295.71768, 429.21497, 575.7106, -209.32932, 325.3819, -196.2329, 29.241337, 492.4863, 487.20416, 367.9334, 555.9564, -65.885704, -661.59143, 352.56372, 365.47507, 443.90753, -174.48686, 43.444374, -87.75733, 135.01659, -87.998505, -131.62091, 507.35995, -381.4495, 316.97052, -180.86392, -360.95612, -215.91705, -57.41719, 78.69461, 434.67615, 443.90173, -98.27012, 490.26306, -27.099842, 453.047, -194.5919, -226.2604, 408.23822, -223.1793, -195.70067, -200.19359, -124.80491, -75.65874, 265.27518, 514.58105, 333.31277, -65.054054, -301.0536, 353.756, -210.74315, -101.0119, -597.9138, 327.80643, 19.087269, 370.67725, -123.20141, 302.66617, 314.08582, 564.9157, -132.21332, -155.65051, 450.01483, -1.3729472, 496.63882, 562.6226, -645.0663, 355.73813, 408.53305, 144.58168, 532.80707, -318.217, -138.07735, 563.82605, -54.75287, -247.0837, -208.71011, 520.3262, -182.79553, 568.31647, -17.530556, -199.16608, 171.1127, -258.868, -565.0815, -133.85379, 513.2459, -234.72336, 88.33672, -295.77655, 464.78992, -110.37497, -81.74376, -126.87503, 35.1478, 364.46054, 404.15674, 113.357346, -139.67027, 395.2212, 433.70868, -336.00195, 371.948, -23.414541, -105.532906, 358.5866, -629.6874, -95.12506, -350.56635, 513.89557, 37.498886, -246.81125, 49.15648, -26.1159, -189.1795, 397.89008, -169.25534, -101.50186, -111.1866, 174.66713, -158.23381, 427.27243, 406.90524, 413.27322, -147.83865, 395.57242, 292.48752, 368.47388, 320.56885, 292.5561, 332.01282, -205.00449, 501.44452, -460.438, -199.63759, 101.04212, -146.89171, 430.7632, 376.24023, 284.8318, 550.2807, -146.6553, -112.076355, 444.17334, 52.244987, -191.30435, 143.37915, -473.0238, 453.96918, -106.33687, -634.15796, -591.13586, 538.7013, 366.37192, 432.19333, 419.90015, -22.168282, -26.646534, 306.90146, -172.90637, 441.7511, 512.60486, 444.48047, -174.77438, 505.74423, -53.96697, 480.06058, 65.85916, -167.96301, 94.650116, -386.09924, 42.75401, -592.36194, 437.47055, 296.17697, 48.31868, -135.43297, -632.35645, -154.22095, 538.7547, 470.0645, -117.88295, -165.42244, 115.52963, -297.1556, -374.74863, -202.46413, -195.69019, 569.974, -257.5939, -207.12218, -131.4938, -142.46582, -215.88965, 198.47556, 506.626, -235.19377, -179.68358, 522.0766, 65.93471, 375.73474, -124.89845, -164.4307, 428.6332, -514.54785, -209.21434, 102.9285, 103.48978, 474.7658, 156.5382, 512.65265, 525.9707, 346.53525, 548.71277, -40.104244, 375.17612, 514.06665, 276.97723, 0.8133972, 244.06308, 564.8344, -212.29413, -211.32469, 356.57053, 83.90389, -153.2768, 382.80502, -249.05118, 455.39026, 144.39108, -268.6388, -151.56772, -17.877512, -64.43591, 303.75256, 569.56616, 514.67804, 439.39166, 459.78674, 154.47063, 302.40555, -587.3763, -148.8328, -150.4607, 447.42517, -70.40685, 251.54305, -5.664095, 9.0303335, 448.4643, 395.2298, 12.5679, -292.70535, -59.844955, 212.48763, -173.01555, -159.77477, 35.56771, 328.64233, -145.9258, 458.3174, 535.75977, -106.97348, 22.999712, 36.92298, 366.68314, 325.5442, -148.13516, -326.48386, 427.0561, 352.39154, -118.37005, 307.81, 285.04697, -194.66736, -167.12708, -124.1349, -347.91202, 397.21884, -276.7274, -327.94183, -227.88443, -167.60327, -188.58363, 351.87927, -177.56326, 414.3587, 181.14444, -228.30936, 420.8944, -614.6715, -164.67151, -203.95721, 422.3495, -160.47331, 257.63498, -130.12991, -195.50627, -100.40757, 359.17133, -124.787415, 537.27075, -167.61717, 175.90894, 243.85336, 369.93796, 466.41425, -310.4394, 176.91565, 444.38745, -132.22182, -53.97216, 399.21558, -67.09253, 510.1849, 89.513885, -439.04193, -205.40756, 435.26227, -206.82735, -540.1492, 290.28906, -480.16937, -200.8374, -370.8554, -528.2823, -203.96725, 492.58267, 558.0534, -272.55286, -177.21364, -411.4649, 77.23907, -568.7224, 568.7087, 81.27899, 289.79813, 424.69806, 294.2538, -310.45593, -136.38417, -291.20737, -297.2259, -340.7343, 460.18512, 524.2123, -145.75232, -194.67587, 345.3665, -129.23299, -176.90732, -130.83655, 12.040231, 475.5986, 260.73096, -70.006805, 545.0198, 340.2876, 233.45328, 374.05847, 28.007412, -188.79947, 115.63993, 450.32022, -182.6952, 55.08767, 414.355, -262.67014, 7.6897063, -154.74529, 52.50093, 546.1105, -221.9799, -174.34338, 437.16727, 171.44234, 406.97955, 297.1172, 337.33548};
    std::vector<float> goal_z = {5.372072, 5.3720665, 5.3720665, 5.3727283, 32.71784, 5.3720665, 5.373518, 15.498206, 5.3720665, 5.3728237, 6.0980864, 5.372217, 5.3720665, 5.372573, 5.3729725, 5.3720655, 5.3720503, 5.372572, 5.3725166, 5.3721685, 5.3728848, 5.372052, 5.3726473, 5.372877, 5.3935356, 5.372463, 31.095612, 5.3720665, 5.3720665, 9.638956, 5.3720665, 5.3720665, 9.636888, 5.3732853, 6.2062564, 5.3720665, 5.3830805, 5.3720665, 5.3720665, 5.3720684, 5.3720665, 5.3721066, 5.3720913, 5.3723783, 5.3720665, 5.3720665, 5.372078, 5.3728733, -25661.11, 5.3725433, 5.372204, 7.19577, 5.3729324, 6.098073, 5.3720665, 5.3720665, 5.372095, 6.4417048, 10.713971, 5.3730774, 5.3720665, 5.372217, 5.372674, 10.279131, 5.372096, 5.3720665, 5.3726425, 7.1298323, 5.3736596, 5.3724747, 5.3720665, 5.3720493, 5.3730583, 5.8793507, 5.3800344, 5.372123, 14.43379, 5.3721, 5.3724833, 5.3720665, 5.372057, 5.3725967, 5.372883, 5.3720665, 5.3728848, 5.3720603, 5.3720665, 5.3720665, 5.3724003, 5.3721027, 2.2187262, 5.372841, 5.3720665, 6.458581, 5.372802, 5.372883, 5.372695, 11.497971, 5.3720665, 5.3818264, 5.3846006, 5.3723984, 5.5299416, 10.816162, 5.372878, 5.3723783, 5.42132, 5.373003, 5.372549, 5.372842, 5.37237, 5.372057, 5.3728867, 5.372957, 5.3723097, 7.283767, 5.3730335, 5.3727894, 5.3720665, 5.3724823, 5.3720665, 5.3720665, 5.3720665, 5.37265, 5.37269, 5.372822, 5.3720665, 5.3721333, 5.3720665, 5.3722925, 14.035299, 5.3720665, 5.3720875, 5.3720665, 5.372074, 5.3720665, 5.3720493, 5.372719, 5.3727074, 5.3720665, 6.967663, 5.372879, 10.631177, 5.3720894, 5.372077, 5.37232, 5.3724957, 5.3723927, 5.3720665, 6.679183, 5.3720665, 5.3720665, 5.3721037, 12.171927, 5.372877, 5.3720636, 5.3720603, 5.3720703, 5.372079, 6.115175, 5.3720665, 7.922208, 5.3728724, 5.3720665, 5.372879, 5.3720865, 5.3720503, 5.3723745, 5.3720493, 5.372591, 16.349373, 5.372882, 5.3720856, 5.372075, 32.71592, 5.3724947, 5.372078, 5.372883, 25.92253, 5.3728676, 5.3720665, 5.3720665, 5.3720665, 9.4627905, 5.3720493, 0.09065509, 5.3720655, 5.3720665, 5.3720665, 10.990021, 5.3720665, 5.3727646, 5.3721905, 5.372074, 5.3726454, 5.372861, 5.3720665, 5.3720665, 5.3720665, 5.3720694, 5.3720713, 5.3727856, 5.3720613, 5.3720646, 5.372818, 5.372877, 5.372758, 5.37212, 6.0978336, 5.372755, 5.372057, 5.3720665, 5.372877, 8.21122, 5.372838, 5.372761, 5.3720665, 5.3720665, 5.372921, 2.7975578, 5.3720665, 5.372057, 3.6588159, 5.3720665, 0.7118945, 5.3720665, 5.3720665, 5.383436, 5.3720665, 5.3720818, 5.3727922, 5.372061, 5.372076, 5.372078, 5.3720665, 5.372057, 5.3728704, 5.3720665, 6.4203258, 5.3720665, 5.3722296, 5.3728714, 5.3720665, 5.3720636, 5.372074, 5.3720665, 5.3727846, 5.3720503, 5.3720665, 5.3727245, 5.3720665, 5.372183, 5.3728514, 5.3720665, 5.3720703, 15.044289, 5.372074, 5.3720665, 5.3720665, 5.3720665, 5.3720655, 5.3730564, 10.324353, 5.372057, 5.3720665, 12.024912, 5.372057, 5.3720665, 15.171497, 5.3720665, 9.707058, 5.3725796, 5.3720665, 5.372678, 5.3728857, 5.3720684, 5.372761, 5.37278, 8.165314, 15.709482, 5.3720703, 6.7798405, 5.3726997, 5.3723583, 5.3720665, 5.372076, 5.372902, 5.3728275, 4.656451, 12.363775, 5.3725014, 5.372057, 5.372078, 5.3720665, 5.372736, 6.0978994, 5.372344, 5.3720646, 5.3720665, 5.372157, 5.3727894, 5.3720603, 3.2074335, 5.372057, 5.3720665, 5.3720603, 5.3720665, 5.3720503, 5.3720665, 0.29370832, 6.876713, 5.3720665, 5.3720665, 5.3720655, 5.4638824, 5.3720665, 5.3720646, 5.3720665, 5.3720665, 5.3724384, 5.3720665, 5.372858, 11.0322895, 5.3720665, 5.372057, 5.372881, 5.3728724, 5.372801, 5.3720665, 5.3727837, 8.969873, 5.3720665, 5.3720665, 5.3720665, 5.3720665, 5.4328938, 5.3724747, 5.3720665, 5.372629, 5.3720665, 5.3720665, -0.072808266, 5.3720694, 3.2268584, 5.3721886, 5.37206, 5.372074, 5.3728657, 6.2478585, 5.3720665, 5.3729267, 5.372752, 5.3720646, 5.372057, 5.372074, 5.3720665, 11.257588, 5.3720665, 5.372057, 5.3720665, 5.372468, 5.372633, 5.3720665, 5.3720665, 5.372057, 7.034962, 5.372409, 5.5613103, 5.3720493, 5.3720665, 5.3721275, 5.3720665, 5.3724976, 5.374072, 6.240091, 11.154648, 5.372078, 5.3724346, 5.3720665, 5.3720665, 5.3724527, 5.3720636, 5.3728065, 5.372488, 5.3720684, 5.3720665, 5.3720503, 5.3723297, 5.372882, 5.3720665, 5.3720493, 5.372509, 5.372856, 5.372876, 5.372938, 5.372181, 5.3720665, 5.37232, 5.3724833, 5.50631, 5.3728714, 5.372347, 5.372864, 5.3720665, 5.372734, 5.3720913, 5.372261, 5.3726025, 5.3720665, 5.3720503, 0.799469, 6.058429, 15.373046, 5.3758187, 5.3720503, 5.3728676, 5.3720665, 5.3720665, 5.372305, 5.372057, 5.3729515, 5.372608, 5.3720665, 5.372772, 5.3727036, 12.019558, 5.3720665, 5.3727646, 5.3720665, 5.3720665, 5.3726273, 5.3720665, 5.3720684, 5.3741055, 7.800451, 5.3724957, 5.372487, 5.4135923, 5.3720665, 3.6685162, 5.386305, 5.3720665, 5.372326, 5.8911543, 5.3720703, 5.385184, 5.372528, 5.3726454, -0.041918755, 22.125076, 5.372057, 3.864413, 5.3720818, 5.3725405, 5.372921, 1.9342928, 5.3728065, 9.697311, 5.3720665, 5.3720665, 5.3720665, 10.22323, 5.3728495, 5.372778, 5.3720665, 5.3720493, 5.3727856, 5.3720665, 5.372057, 5.372672, 5.3720665, 5.3720665, 5.372489, 5.3727818, 5.3720665, 5.3726587, 5.3720503, 5.372654, 3.639492, 5.3720503, 5.372057, 5.3726273, 14.128801, 5.372074, 5.3724957, 5.3720503, 7.0829663, 5.9521575, 5.3720837, 5.3720665, 5.3720665, 29.104902, 5.3720665, 9.520155, 5.3731337, 14.197947, -1.004189, 5.3720503, 5.3721523, 5.3720665, 5.527771, 5.372718, 0.5626633, 5.372079, 1.1633029, 5.3720665, 5.3720675, 5.3720503, 1.8793182, 5.3720503, -0.6373787, 5.3729286, 9.898281, 5.3720875, -3.933319, 5.372073, 5.576021, 5.3721905, 5.372055, 5.3720665, 5.3720665, 5.3720665, 5.372057, 5.37288, 5.37206, 5.3721714, 5.3728495, 5.372635, 5.372443, 5.372753, 5.372079, 5.372484, 5.3720655, 5.372856, 5.372795, 5.3728056, 5.377885, 5.3720665, 5.3727417, 5.3720665, 5.3720665, 5.3729305, 5.3720603, 5.3720665, 5.3720665, -0.10440159, 15.719942, 11.118353, 5.3720646, 5.403884};

    targetLocation_.Location = FVector(goal_x.at(executionCounter_), goal_y.at(executionCounter_), goal_z.at(executionCounter_) < 5.37f ? 5.38f : goal_z.at(executionCounter_));

    return targetLocation_.Location;
}

bool Navigation::navSystemRebuild()
{
    navSys_ = FNavigationSystem::GetCurrent<UNavigationSystemV1>(pawnAgent_->GetWorld());
    ASSERT(navSys_ != nullptr);

    navData_ = navSys_->GetNavDataForProps(pawnAgent_->GetNavAgentPropertiesRef());
    ASSERT(navData_ != nullptr);

    navMesh_ = Cast<ARecastNavMesh>(navData_);
    ASSERT(navMesh_ != nullptr);

    navmeshBounds_ = nullptr;
    for (TActorIterator<ANavMeshBoundsVolume> it(pawnAgent_->GetWorld()); it; ++it) {
        navmeshBounds_ = *it;
    }
    ASSERT(navmeshBounds_ != nullptr);

    // Set the NavMesh properties:
    navMesh_->AgentRadius = Config::getValue<float>({"SIMULATION_CONTROLLER", "NAVIGATION", "NAVMESH", "AGENT_RADIUS"});
    navMesh_->AgentHeight = Config::getValue<float>({"SIMULATION_CONTROLLER", "NAVIGATION", "NAVMESH", "AGENT_HEIGHT"});
    navMesh_->CellSize = Config::getValue<float>({"SIMULATION_CONTROLLER", "NAVIGATION", "NAVMESH", "CELL_SIZE"});
    navMesh_->CellHeight = Config::getValue<float>({"SIMULATION_CONTROLLER", "NAVIGATION", "NAVMESH", "CELL_HEIGHT"});
    navMesh_->AgentMaxSlope = Config::getValue<float>({"SIMULATION_CONTROLLER", "NAVIGATION", "NAVMESH", "AGENT_MAX_SLOPE"});
    navMesh_->AgentMaxStepHeight = Config::getValue<float>({"SIMULATION_CONTROLLER", "NAVIGATION", "NAVMESH", "AGENT_MAX_STEP_HEIGHT"});
    navMesh_->MergeRegionSize = Config::getValue<float>({"SIMULATION_CONTROLLER", "NAVIGATION", "NAVMESH", "MERGE_REGION_SIZE"});
    navMesh_->MinRegionArea = Config::getValue<float>({"SIMULATION_CONTROLLER", "NAVIGATION", "NAVMESH", "MIN_REGION_AREA"}); // ignore region that are too small
    navMesh_->MaxSimplificationError = Config::getValue<float>({"SIMULATION_CONTROLLER", "NAVIGATION", "NAVMESH", "MAX_SIMPLIFINCATION_ERROR"});

    // Dynamic update navMesh location and size
    FBox worldBox = GetWorldBoundingBox();
    navmeshBounds_->GetRootComponent()->SetMobility(EComponentMobility::Movable);
    navmeshBounds_->SetActorLocation(worldBox.GetCenter(), false);          // Place the navmesh at the center of the map
    navmeshBounds_->SetActorRelativeScale3D(worldBox.GetSize() / 200.0f);   // Rescae the navmesh
    navmeshBounds_->GetRootComponent()->UpdateBounds();
    navSys_->OnNavigationBoundsUpdated(navmeshBounds_);

    if (Config::getValue<bool>({"SIMULATION_CONTROLLER", "NAVIGATION", "NAVMESH", "USE_STATIC_NAVMESH"})) {
        navmeshBounds_->GetRootComponent()->SetMobility(EComponentMobility::Static);
    }
    else { // A dynmic navmesh will account for changes occuring in the environment at runtime. But this is more computationally intensive...
        navmeshBounds_->GetRootComponent()->SetMobility(EComponentMobility::Movable); 
    }

    navSys_->Build(); // Rebuild NavMesh, required for update AgentRadius

    return true;
}

void Navigation::traceGround(FVector& spawnPosition, FRotator& spawnRotator, const FVector& boxHalfSize)
{
    FVector startLoc = spawnPosition + FVector(0, 0, 100);
    FVector endLoc = spawnPosition + FVector(0, 0, -1000);

    FCollisionQueryParams collisionParams(FName(TEXT("trace2ground")), true, pawnAgent_);
    FHitResult hit(ForceInit);

    if (UKismetSystemLibrary::BoxTraceSingle(pawnAgent_->GetWorld(), startLoc, endLoc, boxHalfSize, spawnRotator, ETraceTypeQuery::TraceTypeQuery1, false, TArray<AActor*>(), EDrawDebugTrace::Type::ForDuration, hit, true)) {
        spawnPosition = hit.Location;
    }
}

FBox Navigation::GetWorldBoundingBox(bool bScaleCeiling)
{
    FBox box(ForceInit);
    for (TActorIterator<AActor> it(pawnAgent_->GetWorld()); it; ++it) {
        if (it->ActorHasTag("architecture") || it->ActorHasTag("furniture")) {
            box += it->GetComponentsBoundingBox(false, true);
        }
    }
    // Remove ceiling
    return !bScaleCeiling ? box : box.ExpandBy(box.GetSize() * 0.1f).ShiftBy(FVector(0, 0, -0.3f * box.GetSize().Z));
}


